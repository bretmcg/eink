<!DOCTYPE html>
<html lang="en">
<head>
    <title>Zen Reader</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="style.css">

    <link rel="stylesheet" href="standard-style.css">

    <link rel="stylesheet" href="eink.css" media="screen and (monochrome)">
</head>
<body>
    <div id="content"></div>
<script>
    // 1. The Rendering Logic
    fetch('document.md')
        .then(response => response.text())
        .then(text => {
            const contentDiv = document.getElementById('content');
            
            // Convert MD to HTML
            contentDiv.innerHTML = marked.parse(text);

            // RUN THE CALLOUT POLYFILL
            processCallouts(contentDiv);
        });

    // 2. The Callout Processor Function
    function processCallouts(container) {
        // Find all block quotes
        const quotes = container.querySelectorAll('blockquote');

        quotes.forEach(quote => {
            // Look at the first paragraph inside the quote
            const firstP = quote.querySelector('p');
            if (!firstP) return;

            // Check if it starts with [!TYPE]
            // Regex captures: [!TYPE] and optional Title
            const match = firstP.textContent.match(/^\[!(\w+)\]\s*(.*)?$/);

            if (match) {
                const type = match[1].toLowerCase();
                const title = match[2] || type; // Default to type name if no title

                // Create the Callout Wrapper
                const calloutDiv = document.createElement('div');
                calloutDiv.className = 'callout';
                calloutDiv.setAttribute('data-type', type);

                // Create Title Bar
                // We use simple emojis as icons to avoid loading an SVG library
                const icons = { note: 'üìù', info: '‚ÑπÔ∏è', todo: '‚úÖ', warning: '‚ö†Ô∏è', danger: 'üî•', tip: 'üí°' };
                const icon = icons[type] || 'üìå';

                const titleDiv = document.createElement('div');
                titleDiv.className = 'callout-title';
                titleDiv.innerHTML = `<span>${icon}</span> ${title}`;

                // Create Content Container
                const contentDiv = document.createElement('div');
                contentDiv.className = 'callout-content';
                
                // Remove the [!INFO] line from the text, keep the rest
                // We clone the paragraph to avoid destroying the original immediately
                let newContent = firstP.innerHTML.replace(/^\[!(\w+)\]\s*(.*)?(\n|<br>)?/, '');
                
                // If the first P was *only* the title, we might have valid content in subsequent siblings
                // But marked.js usually puts the first line of text in that same P.
                // A simpler strategy for visual accuracy:
                // Just take all children of the blockquote, but fix the first P.
                
                firstP.innerHTML = newContent; // Update the text in the DOM
                
                // Move all blockquote children into the new contentDiv
                while (quote.firstChild) {
                    contentDiv.appendChild(quote.firstChild);
                }

                // Assemble
                calloutDiv.appendChild(titleDiv);
                calloutDiv.appendChild(contentDiv);

                // Replace the original Blockquote with our new Callout
                quote.parentNode.replaceChild(calloutDiv, quote);
            }
        });
    }

    document.addEventListener('click', function() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen();
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
    });

    // Auto-refresh logic (keep this if you use live-server)
    // const socket = new WebSocket('ws://' + location.host + '/live-server'); ... 
    // (Live-server injects its own script, so you don't actually need to write auto-refresh code manually!)
</script>
</body>
</html>

