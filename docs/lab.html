<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Ink Lab</title>
    <style>
        :root {
            --bg: #ffffff;
            --fg: #000000;
            --accent: #000000; /* Avoid greys; they dither poorly on E-ink */
        }
        body {
            background: var(--bg);
            color: var(--fg);
            font-family: monospace; /* Monospace is sharper on low-ppi e-ink */
            margin: 0;
            padding: 10px;
            overflow: hidden; /* Prevent scrolling during drag tests */
        }

        /* High Contrast UI Elements */
        .panel { border: 4px solid var(--fg); padding: 15px; margin-bottom: 20px; }

        button {
            background: var(--bg);
            border: 4px solid var(--fg);
            padding: 15px 25px;
            font-size: 1.2rem;
            font-weight: 900;
            margin-right: 10px;
            cursor: pointer;
        }
        button:active { background: var(--fg); color: var(--bg); }

        /* Animation Stage */
        #stage {
            width: 100%;
            height: 250px;
            border: 2px solid var(--fg);
            position: relative;
            margin-bottom: 10px;
        }

        /* Ghosting Test Object */
        #box {
            width: 80px;
            height: 80px;
            background: var(--fg);
            position: absolute;
            top: 85px;
            left: 0;
        }

        /* PDF Viewport (Uses native Android viewer) */
        #pdf-viewer {
            width: 100%;
            height: 60vh;
            border: 4px solid var(--fg);
        }

        /* Stylus Drawing Canvas */
        #draw-canvas {
            width: 100%;
            height: 300px;
            border: 2px solid var(--fg);
            touch-action: none; /* Prevent scrolling while drawing */
            cursor: crosshair;
        }
        #draw-stats {
            margin-top: 10px;
            font-size: 1rem;
        }

        /* Tap Latency Test */
        #tap-target {
            width: 100%;
            height: 150px;
            border: 4px solid var(--fg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 900;
            user-select: none;
            cursor: pointer;
        }
        #tap-target.tapped {
            background: var(--fg);
            color: var(--bg);
        }
        #latency-results {
            margin-top: 10px;
            font-size: 1rem;
        }
    </style>
</head>
<body>
    <div class="panel">
        <h1>E-Ink Animation Test</h1>
        <div id="stage"><div id="box"></div></div>
        <div style="margin-top:10px;">
            <button onclick="toggleAnim()">Start/Stop</button>
            <button onclick="invert()">Invert UI</button>
        </div>
        <p id="fps">FPS: 0</p>
    </div>

    <div class="panel">
        <h2>Stylus Drawing Test</h2>
        <canvas id="draw-canvas"></canvas>
        <div style="margin-top:10px;">
            <button onclick="clearCanvas()">Clear</button>
            <button onclick="togglePressure()">Pressure: ON</button>
        </div>
        <div id="draw-stats">
            Points/sec: <span id="pps">0</span> |
            Pressure: <span id="pressure">N/A</span> |
            Total points: <span id="total-points">0</span>
        </div>
    </div>

    <div class="panel">
        <h2>Tap Latency Test</h2>
        <div id="tap-target">TAP HERE</div>
        <div id="latency-results">
            Last: <span id="last-latency">--</span>ms |
            Avg: <span id="avg-latency">--</span>ms |
            Min: <span id="min-latency">--</span>ms |
            Taps: <span id="tap-count">0</span>
        </div>
        <button onclick="resetLatency()" style="margin-top:10px;">Reset Stats</button>
    </div>

    <div class="panel">
        <h2>PDF Viewer</h2>
        <iframe id="pdf-viewer" src="test.pdf"></iframe>
    </div>

    <script>
        // Animation Logic
        let pos = 0;
        let speed = 20;
        let dir = 1;
        let active = false;
        const box = document.getElementById('box');
        const fpsLabel = document.getElementById('fps');
        let frames = 0; let lastTime = performance.now();

        function loop(time) {
            if(!active) return;

            // FPS Counter
            frames++;
            if (time - lastTime >= 1000) {
                fpsLabel.innerText = `FPS: ${frames}`;
                frames = 0; lastTime = time;
            }

            // Movement
            const maxW = document.getElementById('stage').clientWidth - 80;
            pos += speed * dir;
            if(pos > maxW || pos < 0) dir *= -1;
            box.style.transform = `translateX(${pos}px)`;

            requestAnimationFrame(loop);
        }

        function toggleAnim() {
            active = !active;
            if(active) requestAnimationFrame(loop);
        }

        function invert() {
            const root = document.documentElement;
            const currentBg = getComputedStyle(root).getPropertyValue('--bg').trim();
            if (currentBg === '#ffffff') {
                root.style.setProperty('--bg', '#000000');
                root.style.setProperty('--fg', '#ffffff');
            } else {
                root.style.setProperty('--bg', '#ffffff');
                root.style.setProperty('--fg', '#000000');
            }
        }

        // ========== STYLUS DRAWING TEST ==========
        const canvas = document.getElementById('draw-canvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let usePressure = true;
        let pointCount = 0;
        let totalPoints = 0;
        let lastPointTime = performance.now();
        let pointsThisSecond = 0;

        // Set canvas size to match display size
        function resizeCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        canvas.addEventListener('pointerdown', (e) => {
            isDrawing = true;
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
            e.preventDefault();
        });

        canvas.addEventListener('pointermove', (e) => {
            if (!isDrawing) return;

            // Track points per second
            pointsThisSecond++;
            totalPoints++;
            const now = performance.now();
            if (now - lastPointTime >= 1000) {
                document.getElementById('pps').textContent = pointsThisSecond;
                pointsThisSecond = 0;
                lastPointTime = now;
            }
            document.getElementById('total-points').textContent = totalPoints;

            // Pressure support (stylus)
            const pressure = e.pressure || 0.5;
            document.getElementById('pressure').textContent = pressure.toFixed(2);

            // Line width based on pressure
            const baseWidth = 3;
            ctx.lineWidth = usePressure ? baseWidth + (pressure * 8) : baseWidth;

            // Use current foreground color
            const fg = getComputedStyle(document.documentElement).getPropertyValue('--fg').trim();
            ctx.strokeStyle = fg;

            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);

            e.preventDefault();
        });

        canvas.addEventListener('pointerup', () => { isDrawing = false; });
        canvas.addEventListener('pointerleave', () => { isDrawing = false; });

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            totalPoints = 0;
            document.getElementById('total-points').textContent = 0;
        }

        function togglePressure() {
            usePressure = !usePressure;
            event.target.textContent = `Pressure: ${usePressure ? 'ON' : 'OFF'}`;
        }

        // ========== TAP LATENCY TEST ==========
        const tapTarget = document.getElementById('tap-target');
        let tapStartTime = 0;
        let latencies = [];

        tapTarget.addEventListener('pointerdown', (e) => {
            tapStartTime = performance.now();

            // Visual feedback as fast as possible
            tapTarget.classList.add('tapped');
            tapTarget.textContent = 'TAPPED!';

            // Measure latency (time from event to now, essentially 0,
            // but the real latency is perceived by the user on e-ink)
            const latency = performance.now() - tapStartTime;
            latencies.push(latency);

            document.getElementById('last-latency').textContent = latency.toFixed(1);
            document.getElementById('tap-count').textContent = latencies.length;

            const avg = latencies.reduce((a, b) => a + b, 0) / latencies.length;
            document.getElementById('avg-latency').textContent = avg.toFixed(1);

            const min = Math.min(...latencies);
            document.getElementById('min-latency').textContent = min.toFixed(1);

            e.preventDefault();
        });

        tapTarget.addEventListener('pointerup', () => {
            tapTarget.classList.remove('tapped');
            tapTarget.textContent = 'TAP HERE';
        });

        function resetLatency() {
            latencies = [];
            document.getElementById('last-latency').textContent = '--';
            document.getElementById('avg-latency').textContent = '--';
            document.getElementById('min-latency').textContent = '--';
            document.getElementById('tap-count').textContent = '0';
        }
    </script>
</body>
</html>
